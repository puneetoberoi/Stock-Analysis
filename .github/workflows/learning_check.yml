name: Daily Learning Check

on:
  schedule:
    - cron: '0 21 * * *'  # 4 PM EST - after market close
  workflow_dispatch:

jobs:
  learning:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install yfinance pandas
    
    - name: Run Learning Engine
      run: |
        python src/modules/learning_engine.py
    
    - name: Show Learning Stats
      run: |
        echo "=== OVERALL ACCURACY ==="
        sqlite3 src/modules/data/learning.db << 'EOF'
        .headers on
        .mode column
        
        SELECT 
          llm_model,
          SUM(total_predictions) as total,
          SUM(correct_predictions) as correct,
          ROUND(100.0 * SUM(correct_predictions) / SUM(total_predictions), 1) as accuracy
        FROM accuracy_tracking
        GROUP BY llm_model;
        EOF
        
        echo -e "\n=== TOP PERFORMING STOCKS ==="
        sqlite3 src/modules/data/learning.db << 'EOF'
        .headers on
        .mode column
        
        SELECT 
          stock,
          total_predictions as predictions,
          correct_predictions as correct,
          accuracy_pct
        FROM accuracy_tracking
        WHERE total_predictions >= 5
        ORDER BY accuracy_pct DESC
        LIMIT 10;
        EOF
