name: Test Learning System

on:
  workflow_dispatch:  # Manual trigger for testing
  schedule:
    - cron: '0 22 * * *'  # 5 PM EST - after market close

jobs:
  test_learning:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas
    
    - name: Check Database Status
      run: |
        echo "=== Database Status ==="
        if [ -f "src/modules/data/learning.db" ]; then
          echo "✅ learning.db exists"
          echo "Size: $(ls -lh src/modules/data/learning.db | awk '{print $5}')"
        else
          echo "❌ learning.db not found - creating it"
          mkdir -p src/modules/data
          sqlite3 src/modules/data/learning.db < src/modules/schemas.sql
        fi
        
    - name: Run Learning Check
      run: |
        # Update check_learning.py to use correct path
        sed -i "s|'learning.db'|'src/modules/data/learning.db'|g" src/modules/check_learning.py
        python src/modules/check_learning.py
        
    - name: Check Predictions Count
      run: |
        echo "=== Checking Predictions ==="
        sqlite3 src/modules/data/learning.db "SELECT COUNT(*) as total FROM predictions;" || echo "No predictions table"
        
        echo "=== Recent Predictions ==="
        sqlite3 src/modules/data/learning.db "SELECT stock, prediction, confidence, datetime(timestamp) FROM predictions ORDER BY timestamp DESC LIMIT 5;" || echo "No data"
        
        - name: Check Accuracy
        run: |
          cho "=== Checking Predictions ==="
        sqlite3 src/modules/data/learning.db "SELECT COUNT(*) as total FROM predictions;" || echo "No predictions table"
        
        echo "=== Recent Predictions ==="
        sqlite3 src/modules/data/learning.db "SELECT stock, prediction, confidence, datetime(timestamp) FROM predictions ORDER BY timestamp DESC LIMIT 5;" || echo "No data"
        python check_accuracy.py
